<div class="cv-editor">
  <!-- Header -->
  <div class="editor-header">
    <button nz-button nzType="default" class="back-btn" (click)="onBack()">
      <span class="btn-icon">←</span>
      <span class="btn-text">Indietro</span>
    </button>
    <h2>Modifica CV</h2>
    <button nz-button nzType="primary" class="save-btn" (click)="onSave()" [disabled]="!cvForm.valid">
      <span class="btn-icon">✓</span>
      <span class="btn-text">Salva</span>
    </button>
  </div>

  <!-- Steps -->
  <div class="steps-container">
    <nz-steps [nzCurrent]="currentStep" nzSize="small" class="wizard-steps">
      <nz-step nzTitle="Personali" [nzIcon]="currentStep > 0 ? 'check' : 'user'"></nz-step>
      <nz-step nzTitle="Esperienza" [nzIcon]="currentStep > 1 ? 'check' : 'solution'"></nz-step>
      <nz-step nzTitle="Formazione" [nzIcon]="currentStep > 2 ? 'check' : 'book'"></nz-step>
      <nz-step nzTitle="Competenze" [nzIcon]="currentStep > 3 ? 'check' : 'star'"></nz-step>
      <nz-step nzTitle="Lingue" [nzIcon]="currentStep > 4 ? 'check' : 'global'"></nz-step>
    </nz-steps>
  </div>

  <!-- Form -->
  <form [formGroup]="cvForm" class="cv-form">
    
    <!-- Step 0: Informazioni Personali -->
    <div class="step-content" *ngIf="currentStep === 0">
      <div class="step-header">
        <h3><span nz-icon nzType="user"></span> Informazioni Personali</h3>
        <p>Inserisci i tuoi dati di contatto e profilo professionale</p>
      </div>

      <div formGroupName="personalInfo" class="form-section">
        <nz-form-item>
          <nz-form-label nzRequired>Nome Completo</nz-form-label>
          <nz-form-control nzErrorTip="Il nome è obbligatorio">
            <input nz-input formControlName="name" placeholder="Mario Rossi" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>Titolo Professionale</nz-form-label>
          <nz-form-control nzErrorTip="Il titolo è obbligatorio">
            <input nz-input formControlName="title" placeholder="Sviluppatore Full Stack" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>Email</nz-form-label>
          <nz-form-control nzErrorTip="Inserisci un'email valida">
            <input nz-input type="email" formControlName="email" placeholder="mario@email.com" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>Telefono</nz-form-label>
          <nz-form-control nzErrorTip="Il telefono è obbligatorio">
            <input nz-input type="tel" formControlName="phone" placeholder="+39 123 456 7890" />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>Città</nz-form-label>
          <nz-form-control nzErrorTip="La città è obbligatoria">
            <input nz-input formControlName="location" placeholder="Seleziona o scrivi città" 
              [nzAutocomplete]="cityAuto" />
            <nz-autocomplete #cityAuto>
              <nz-auto-option *ngFor="let city of allCities" [nzValue]="city">{{city}}</nz-auto-option>
            </nz-autocomplete>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item *ngIf="hasPhoto">
          <nz-form-label>Foto Profilo</nz-form-label>
          <nz-form-control>
            <div class="photo-upload">
              <div class="photo-preview" *ngIf="cvForm.get('personalInfo.photo')?.value">
                <img [src]="cvForm.get('personalInfo.photo')?.value" alt="Foto" />
                <button nz-button nzType="primary" nzShape="circle" nzSize="small" class="remove-photo" (click)="removePhoto()">
                  <span nz-icon nzType="delete"></span>
                </button>
              </div>
              <div class="photo-dropzone" *ngIf="!cvForm.get('personalInfo.photo')?.value"
                   (drop)="onPhotoDrop($event)" (dragover)="onPhotoDragOver($event)">
                <span nz-icon nzType="camera" class="upload-icon"></span>
                <p>Trascina foto o clicca</p>
                <div class="upload-btns">
                  <input type="file" #photoInput accept="image/*" (change)="onPhotoUpload($event)" hidden>
                  <button nz-button nzType="primary" nzSize="small" (click)="photoInput.click()">
                    <span nz-icon nzType="upload"></span> Carica
                  </button>
                  <button nz-button nzSize="small" (click)="openCamera()" class="camera-btn">
                    <span nz-icon nzType="camera"></span> Scatta
                  </button>
                </div>
                <video #videoElement autoplay playsinline style="display:none; width: 100%; max-width: 400px; margin: 12px auto 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></video>
                <canvas #canvasElement style="display:none;"></canvas>
              </div>
            </div>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label nzRequired>Profilo Professionale</nz-form-label>
          <nz-form-control nzErrorTip="Il profilo è obbligatorio">
            <textarea nz-input formControlName="summary" rows="4" 
              placeholder="Descrivi brevemente la tua esperienza..."></textarea>
          </nz-form-control>
        </nz-form-item>
      </div>
    </div>

    <!-- Step 1: Esperienza -->
    <div class="step-content" *ngIf="currentStep === 1">
      <div class="step-header">
        <h3><span nz-icon nzType="solution"></span> {{ experienceSectionTitle }}</h3>
        <p>{{ cvData?.userType === 'student' ? 'Aggiungi le tue esperienze formative (stage, tirocini, progetti)' : 'Aggiungi le tue esperienze professionali' }}</p>
      </div>

      <div formArrayName="experience" class="form-section">
        <div *ngFor="let exp of experienceArray.controls; let i = index" [formGroupName]="i" class="card-item">
          <div class="card-header">
            <span class="card-title">Esperienza {{i + 1}}</span>
            <button nz-button nzType="text" nzDanger nzSize="small" (click)="removeExperience(i)">
              <span nz-icon nzType="delete"></span>
            </button>
          </div>

          <nz-form-item>
            <nz-form-label nzRequired>{{ experienceCompanyLabel }}</nz-form-label>
            <nz-form-control [nzErrorTip]="experienceCompanyLabel + ' è obbligatorio/a'">
              <input nz-input formControlName="company" [placeholder]="cvData?.userType === 'student' ? 'Nome Organizzazione' : 'Nome Azienda'" />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>{{ experiencePositionLabel }}</nz-form-label>
            <nz-form-control [nzErrorTip]="experiencePositionLabel + ' è obbligatorio/a'">
              <input nz-input formControlName="position" [placeholder]="cvData?.userType === 'student' ? 'Stage, Tirocinio, Progetto' : 'Ruolo'" />
            </nz-form-control>
          </nz-form-item>

          <div class="date-row">
            <nz-form-item>
              <nz-form-label nzRequired>Inizio</nz-form-label>
              <nz-form-control nzErrorTip="Obbligatorio">
                <input nz-input formControlName="startDate" placeholder="2020-01" />
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-label nzRequired>Fine</nz-form-label>
              <nz-form-control nzErrorTip="Obbligatorio">
                <input nz-input formControlName="endDate" placeholder="Presente" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <nz-form-item>
            <nz-form-label nzRequired>Descrizione</nz-form-label>
            <nz-form-control nzErrorTip="La descrizione è obbligatoria">
              <textarea nz-input formControlName="description" rows="3" 
                placeholder="Responsabilità e risultati..."></textarea>
            </nz-form-control>
          </nz-form-item>
        </div>

        <button nz-button nzType="dashed" nzBlock (click)="addExperience()" class="add-btn">
          <span nz-icon nzType="plus"></span> Aggiungi Esperienza
        </button>
      </div>
    </div>

    <!-- Step 2: Formazione -->
    <div class="step-content" *ngIf="currentStep === 2">
      <div class="step-header">
        <h3><span nz-icon nzType="book"></span> Formazione</h3>
        <p>Aggiungi i tuoi titoli di studio</p>
      </div>

      <div formArrayName="education" class="form-section">
        <div *ngFor="let edu of educationArray.controls; let i = index" [formGroupName]="i" class="card-item">
          <div class="card-header">
            <span class="card-title">Formazione {{i + 1}}</span>
            <button nz-button nzType="text" nzDanger nzSize="small" (click)="removeEducation(i)">
              <span nz-icon nzType="delete"></span>
            </button>
          </div>

          <nz-form-item>
            <nz-form-label nzRequired>Istituzione</nz-form-label>
            <nz-form-control nzErrorTip="L'istituzione è obbligatoria">
              <input nz-input formControlName="institution" placeholder="Seleziona o scrivi (es. ITS, università estera)" 
                [nzAutocomplete]="institutionAuto" />
              <nz-autocomplete #institutionAuto>
                <nz-auto-optgroup nzLabel="Università">
                  <nz-auto-option *ngFor="let uni of allUniversities" [nzValue]="uni">{{uni}}</nz-auto-option>
                </nz-auto-optgroup>
                <nz-auto-optgroup nzLabel="Scuole Superiori">
                  <nz-auto-option *ngFor="let school of allHighSchools" [nzValue]="school">{{school}}</nz-auto-option>
                </nz-auto-optgroup>
              </nz-autocomplete>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Titolo di Studio</nz-form-label>
            <nz-form-control nzErrorTip="Il titolo è obbligatorio">
              <input nz-input formControlName="degree" placeholder="Laurea in..." />
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Città</nz-form-label>
            <nz-form-control nzErrorTip="La città è obbligatoria">
              <input nz-input formControlName="city" placeholder="Seleziona o scrivi città" 
                [nzAutocomplete]="eduCityAuto" />
              <nz-autocomplete #eduCityAuto>
                <nz-auto-option *ngFor="let city of allCities" [nzValue]="city">{{city}}</nz-auto-option>
              </nz-autocomplete>
            </nz-form-control>
          </nz-form-item>

          <div class="date-row">
            <nz-form-item>
              <nz-form-label nzRequired>Inizio</nz-form-label>
              <nz-form-control nzErrorTip="Obbligatorio">
                <input nz-input formControlName="startDate" placeholder="2015-09" />
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <nz-form-label nzRequired>Fine</nz-form-label>
              <nz-form-control nzErrorTip="Obbligatorio">
                <input nz-input formControlName="endDate" placeholder="2020-07" />
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <button nz-button nzType="dashed" nzBlock (click)="addEducation()" class="add-btn">
          <span nz-icon nzType="plus"></span> Aggiungi Formazione
        </button>
      </div>
    </div>

    <!-- Step 3: Competenze -->
    <div class="step-content" *ngIf="currentStep === 3">
      <div class="step-header">
        <h3><span nz-icon nzType="star"></span> Competenze</h3>
        <p>Elenca le tue competenze tecniche e professionali</p>
      </div>

      <div formArrayName="skills" class="form-section">
        <div class="skills-grid">
          <nz-form-item *ngFor="let skill of skillsArray.controls; let i = index">
            <nz-form-control nzErrorTip="Obbligatorio">
              <nz-input-group [nzSuffix]="suffixTpl">
                <input nz-input [formControlName]="i" placeholder="Competenza"
                  nz-autocomplete [nzAutocomplete]="auto"
                  (input)="onSkillSearch($any($event.target).value)" />
              </nz-input-group>
              <nz-autocomplete #auto>
                <nz-auto-option *ngFor="let opt of skillOptions" [nzValue]="opt">{{opt}}</nz-auto-option>
              </nz-autocomplete>
              <ng-template #suffixTpl>
                <button nz-button nzType="text" nzSize="small" nzDanger (click)="removeSkill(i)">
                  <span nz-icon nzType="close"></span>
                </button>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </div>

        <button nz-button nzType="dashed" nzBlock (click)="addSkill()" class="add-btn">
          <span nz-icon nzType="plus"></span> Aggiungi Competenza
        </button>
      </div>
    </div>

    <!-- Step 4: Lingue -->
    <div class="step-content" *ngIf="currentStep === 4">
      <div class="step-header">
        <h3><span nz-icon nzType="global"></span> Lingue</h3>
        <p>Indica le lingue che conosci e il livello</p>
      </div>

      <div formArrayName="languages" class="form-section">
        <div *ngFor="let lang of languagesArray.controls; let i = index" [formGroupName]="i" class="card-item">
          <div class="card-header">
            <span class="card-title">Lingua {{i + 1}}</span>
            <button nz-button nzType="text" nzDanger nzSize="small" (click)="removeLanguage(i)">
              <span nz-icon nzType="delete"></span>
            </button>
          </div>

          <nz-form-item>
            <nz-form-label nzRequired>Lingua</nz-form-label>
            <nz-form-control nzErrorTip="La lingua è obbligatoria">
              <input nz-input formControlName="language" placeholder="Seleziona o scrivi lingua" 
                [nzAutocomplete]="langAuto" />
              <nz-autocomplete #langAuto>
                <nz-auto-option *ngFor="let l of languageOptions" [nzValue]="l">{{l}}</nz-auto-option>
              </nz-autocomplete>
            </nz-form-control>
          </nz-form-item>

          <nz-form-item>
            <nz-form-label nzRequired>Livello</nz-form-label>
            <nz-form-control nzErrorTip="Il livello è obbligatorio">
              <nz-select formControlName="level" nzPlaceHolder="Seleziona livello">
                <nz-option *ngFor="let lvl of languageLevelOptions" [nzValue]="lvl" [nzLabel]="lvl"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </div>

        <button nz-button nzType="dashed" nzBlock (click)="addLanguage()" class="add-btn">
          <span nz-icon nzType="plus"></span> Aggiungi Lingua
        </button>
      </div>
    </div>

  </form>

  <!-- Navigation -->
  <div class="step-navigation">
    <button nz-button nzSize="large" (click)="prevStep()" [disabled]="currentStep === 0">
      <span nz-icon nzType="left"></span> Indietro
    </button>
    <div class="step-indicator">{{currentStep + 1}} / 5</div>
    <button nz-button nzType="primary" nzSize="large" *ngIf="currentStep < 4" (click)="nextStep()" 
      [disabled]="!isStepValid(currentStep)">
      Avanti <span nz-icon nzType="right"></span>
    </button>
    <button nz-button nzType="primary" nzSize="large" *ngIf="currentStep === 4" (click)="onSave()" 
      [disabled]="!cvForm.valid">
      <span nz-icon nzType="check"></span> Completa
    </button>
  </div>
</div>
